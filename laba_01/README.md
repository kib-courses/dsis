# Лабораторная работа №1

Дата проведения лабораторной: **1 октября 2019**.

Лабораторная работа к лекциям:

* [Лекция №1](./../01_lecture.pdf);
* [Лекция №2](./../02_lecture.pdf).

В процессе подготовки лабораторной работы и во время лабораторной работы можно 
и НУЖНО консультироватся друг с другом.

Допускается сдача лабораторной работы командой из 2-х человек 
(но не более!). Формирование команды -- проблема студентов.

## Подготовка к лабораторной работе 

**ВНИМАНИЕ**: эта часть -- домашнее задание. 

Кто его не выполнит, не допускается к лабораторной работе.

### 1. (опционально) Собственный VPS

Желательно установить Virtual Private Server (VPS).

Это опциональное действие. VPS -- это удобно. 
Если у вас есть VPS, вам не нужен мощный ноутбук, вам нужен 
ЭРГОНОМИЧНЫЙ ноутбук, с хорошей батареей. 
В конечном итоге это просто выгодно и удобно. 
А ещё, если у вас есть VPS, вы можете что-либо там запустить и спокойно выключить ноут. 
А завтра утром посмотреть на результат.
(А ещё можно сделать чат-бота, и когда будет выполнено задание -- написать из под бота себе сообщение)

Но вы можете пропустить этот пункт и запускать Jupyter через localhost.
 
Например можно за **2.5$** в месяц (1.95$ + 0.5$ за выделенный IP) арендовать у эстонцев:
https://iphoster.net/tarifs?vid=vds#idz-pricing

**ВАЖНО**: При заказе не забудьте выделенный IP. Это не обязательно, но гораздо удобнее!

(а ещё можно понищебродствовать по приколу и скинутся на пару с кем-то. 
Только не подеритесь, придумайте джентельменские правила работы...)

Настройте .ssh по ключу, отмените вход по паролю. Вот мануал: 
https://losst.ru/avtorizatsiya-po-klyuchu-ssh

### 2. Установка Jupyter

Вот официальная страница: https://jupyter.org

Лучше, проще, быстрее устанавливать через докер: https://hub.docker.com/r/jupyter/datascience-notebook

Но если есть желание блестнуть девопсингом, то вот: https://jupyter.org/install

Если у вас VPS (вы выполнили п.1), то:

1. При установке смените стандартный порт HTTP (или HTTPS) на какой-нибудь другой.
Есть много сниферов по стандартным портам, зачем давать им трафик?
1. Установите пароль на Jupyter. Не забудьте его :)) 

Если локально на ноуте, то это не нужно.

### 3. Hello world на Jupyter

Загрузите хоть какие-нибудь данные и постройте любой график.
Убедитесь, что всё работает. 


### 4. Освойте MarkDawn в Jupyter

Вот мануал: https://jupyter-notebook.readthedocs.io/en/stable/examples/Notebook/Working%20With%20Markdown%20Cells.html

Попишите различные тексты, формулы в LaTeX.

Jypyter -- это мощный инструмент, благодаря которому вы быстро 
будите исследовать данные и автоматически получить вполне годные
(не для маркетинга) отчёты.

### 5. Научитесь сохранять документы в HTML и PDF. 

Очень полезный навык, чтобы быстро поделится результатами.

### 6. Посмотреть различные библиотеки

1. Старый добрый [matplotlib](https://matplotlib.org/gallery/index.html).
1. Более модный нынче [plot.ly](https://plot.ly/python/)
1. [NumPy](https://numpy.org) и [SciPy](https://scipy-cookbook.readthedocs.io)
1. Библиотека [pandas](https://pandas.pydata.org/pandas-docs/stable/). (!) к сожалению порог входа не такой быстрый... 
1. [scikit-learn](https://scikit-learn.org/stable/auto_examples/index.html) [Давида Курнaпо](https://en.wikipedia.org/wiki/David_Cournapeau).

### 7. Обязательно к прочтению (иначе вам будет больно)

Для первого раза стоит просто "просмотреть по диагонали". 

После лабораторной уже прочитать.

Или сразу прочитать... У кого как мозги работают.

1. ["28 Jupyter Notebook Tips, Tricks, and Shortcuts"](https://www.dataquest.io/blog/jupyter-notebook-tips-tricks-shortcuts/)
1. pandas cockbook: [офф.доки](https://pandas.pydata.org/pandas-docs/stable/user_guide/cookbook.html)
или ещё говорят есть на [GitHub](https://github.com/PacktPublishing/Pandas-Cookbook).
1. Лучано Ромальо. "Python. К вершинам мастерства".

## 8. Работа дома

Выполните из лабораторной работы хотя бы 2-3 упражнения. 

А лучше полностью  выполните лабораторную дома (то, что можете),
чтобы более конструктивно потратить своё время при очной встрече.

## Лабораторная работа

### Как проходит лабораторная

В процессе лабораторной работы можно и нужно эксперементировать, пробовать что-либо, 
что не указано в данной step-by-step инструкции.

Цель -- научится. А не сделать и поставить галочку. 

По умолчанию преподаватель считает, что если у вас нет вопросов -- то у вас всё получается.

Если возникает затык, то последовательность действий такая:

1. спросить партнёра в вашей команде (если у вас команда из 2-х человек)
1. яндексить/ погуглить
1. спросить соседа справа (или слева)
1. спросить соседа слева (или справа)
1. спросить всех в чате 
1. ещё раз подумать -- всех ли вы спросили?
1. позвать педагога и потратить его время. 

ЗАМЕЧАНИЕ: не нужно тратить время педагога в чате. Для этого есть очные встречи.

Аналогично, не злимся, если вас спросят сосед слева или справа.

На команду должен быть хотя бы один ноут с установленным Jupyter 
(см. **Подготовка к лабораторной работе** )


###  0. Загрузка данных и их просмотр

**ЗАМЕЧАНИЕ**. Не обязательно выполнять все пункты задания подряд. Так же можно сделать что-либо ещё, кроме этого задания.
Просто посмотреть, изучить, проверить гипотезы. Эксперементируйте! 

Сохраните себе выгрузку [bank_data_1.tar.gz](./data/bank_data_1.tar.gz).

Распакуйте архив и посмотрите на данные.
Попробуйте понять что значат те или иные признаки.

Каждая строка -- это транзакция (событие).
Значения **p1_fraud**, **p2_fraud**, **p3_fraud** -- это **решения** (отклики)
различных ЭС.

Значения X1, X2, ... -- это различные признаки.

Поле RESOLUTION показывает **класс**:

1. **F** -- мошенническая
1. **G** (genuine) -- легитимная
1. **Null** -- нет разметки (почти наверняка легитимная)
1. **U** (unknown) -- неизвестно


### К лекции №1

#### Упражнения

**Упражнение 1.**

  1. Напишите функцию, строящую на плоскости точки от двух переменных (Xi, Xj) Сами Xi и Xj подаются на вход системы.
  2. Проанализируйте всевозможные комбинации признаков. (Каково их количество, кстати?)
Выберете 2-3 наиболее характерных пары признаков и сохраните их в отдельных вкладках юпитера.

**Упражнение 2.**
   
   1. Предположим, что решающее правило >=0.5 – фрод, в остальных случаях – не фрод. По указанной выборки рассчитать: true positive, false positive, true negative, false negative для всех правил
   2. Для каждой ЭС найдите порог решающего правила, для которого false positive не более 0.2
   3. Найдите полноту и точность, напишите "велосипед".
   4. Найдите полноту и точность через стандартную функцию.

**Упражнение 3.**
   1. Постройте ROC кривую для каждого отклика: **p1_fraud**, **p2_fraud** и **p3_fraud**.
   2. Найдите коэффициент Джини для каждого правила.


**Упражнение 4.**

   1. Создайте ансамбль в виде функции голосования при пороге каждого правила >=0.5, >=0.8. Найдите необходимые пороги для каждого правила ЭС, чтобы false positive ансамбля была минимальна.
   2. Создайте ансамбль голосования и постройте его ROC кривую: 

```
 p = (p1_fraud + p2_fraud + p3_fraud)/3. 
```

#### Задачи

**Задача №1**
   
Зададим ансамбль через параметры A, B, C:
```
 p =(A*p1_fraud + B*p2_fraud + C*p3_fraud) / ( A + B + C ).
```
   1. Найдите A, B, C, чтобы коэфициент Джини ансамбля был бы максимальным. 
   1. При каких A, B, C коэфициент Джини минимален?
   1. Найдите A, B, C для максимального true positive при условии, что false positive должен быть равен 0.1.
   1. Каков порог решающего правила? 

**Задача №2**

Посмотрите на данные. Есть ли какая-либо корреляция по городам, посещаемым страницам, суммам транзакций?

Какие ещё есть интересные данные? Какие данные совершенно бесполезны?

Попытайтесь понять, что значит X1, X2, ... 
В чём физический смысл этих признаков?

**Задача №3**

До лекции 2 для вас экспертные системы -- просто чёрные ящики.

Посмотрите на разные чёрные ящики из вводного поста: https://scikit-learn.org/stable/auto_examples/classification/plot_classifier_comparison.html

Постройте аналогичную систему для выгрузки bank_data_1.tar.gz

**Задача №4**

После задач №1 и №2 придумайте свою экспертную систему в виде последовательности действий
if-else

Напишите свой оценщик(estimator), определив функции:

1. fit
2. predict
3. predict_proba

Воспользуйтесь оценщиком для определения скоринга всех функций.

Найдите оптимальную отсечку.

Посчитайте полноту и точность.

### К лекции №2

**Упражнение №5.0.1**  

Освойтесь с NumPy с помощью этого туториала:  

https://jakevdp.github.io/PythonDataScienceHandbook/02.00-introduction-to-numpy.html
  
Перед следующим упражнением, убедитесь что вы понимаете разницу между nparray и стандартным list!  
  
**Упражнение №5.0.2**  
Изучите Pandas - дефакто стандарт для работы с табличными (не bigdata) данными.  

https://jakevdp.github.io/PythonDataScienceHandbook/03.01-introducing-pandas-objects.html

https://jakevdp.github.io/PythonDataScienceHandbook/03.02-data-indexing-and-selection.html

https://jakevdp.github.io/PythonDataScienceHandbook/03.01-introducing-pandas-objects.html 
 
**Упражнение №5.1**  

Сделайте свой датафрейм на основе 2D-nparray  
Он должен поддерживать:  
* построчный индекс  
* хранить названия и порядок колонок  
* функции индексирования:  
 * iloc[i,j] - получить элемент по i-й строке j-й колонке. (i/j также могут быть slice-объектами)  
 * loc[k,z] - получить элемент по k-му значению построчного индекса z-й колонке (k может быть iterable/slice, z - iterable)  
 * [] - переопределить getitem, сделать его алиасом вашей loc-функции  
Также нужно сделать статический метод, читающий CSV:   
`your_package.read_csv(file_path, **csv_opts)`   
и возвращающий инстанс вашего датафрейма с прочитанными данными.    
Метод должен принимать параметры, настраивающие поведение чтения CSV-файла.  

**Упражнение №6.1**

Почитайте про случайный лес в [мануалах scikit](https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier)

Научитесь обучать лес и запускать его.  
Для хранения и передачи данных для sklearn вы должны использовать собственный датафрейм!  

**Упражнение №6.2**

Научитесь визуализировать деревья. Почитайте:

  * [sklearn.tree.export_graphviz](https://scikit-learn.org/stable/modules/generated/sklearn.tree.export_graphviz.html#sklearn.tree.export_graphviz)
  * [How to Visualize a Decision Tree from a Random Forest in Python using Scikit-Learn](https://towardsdatascience.com/how-to-visualize-a-decision-tree-from-a-random-forest-in-python-using-scikit-learn-38ad2d75f21c)

**Задача №7**

Посмотрите на данные из выборки ещё раз. Обучите RF на этих данных.
Сравните RF c алгоритмами **p1_fraud**, **p2_fraud** и **p3_fraud**.

**Задача №8**

Подумайте, как с помощью RF оценивать информативность признаков?
Найдите информативные признаки. 

Сравните результаты с результатами **упражнения №1**.
